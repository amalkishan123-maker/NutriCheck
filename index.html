<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nutri</title>

<style>
body{
  margin:0;
  font-family: Arial, sans-serif;
  background:#0b0b0b;
  color:#fff;
}
.container{
  max-width:420px;
  margin:auto;
  padding:20px;
}
h1{color:#4caf50;margin-bottom:5px}
.tagline{color:#aaa;font-size:14px;margin-bottom:20px}
input{
  width:100%;
  padding:14px;
  border-radius:8px;
  border:none;
  background:#1f1f1f;
  color:#fff;
  margin-bottom:10px;
}
button{
  width:100%;
  padding:14px;
  border-radius:8px;
  border:none;
  font-weight:bold;
  margin-bottom:10px;
  cursor:pointer;
}
.scanBtn{
  background:#222;
  color:#fff;
}
.checkBtn{
  background:#4caf50;
  color:#000;
}
.result{margin-top:20px}
.score{
  width:120px;height:120px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:34px;
  margin:15px auto;
}
.healthy{background:#1b5e20}
.moderate{background:#f9a825;color:#000}
.unhealthy{background:#8e0000}
.warning{color:#ffcc80;font-size:13px;margin-top:10px}
.ingredients{font-size:13px;color:#bbb;line-height:1.5}
video{width:100%;border-radius:10px;margin-bottom:10px;display:none}
</style>
</head>

<body>
<div class="container">
  <h1>Nutri</h1>
  <div class="tagline">Scan ¬∑ Understand ¬∑ Decide</div>

  <input id="barcode" placeholder="Enter barcode number">
  <button class="scanBtn" onclick="startScan()">üì∑ Scan Barcode</button>
  <button class="checkBtn" onclick="checkFood()">Check Food</button>

  <video id="video"></video>
  <div id="output" class="result"></div>
</div>

<script>
let stream=null;

async function startScan(){
  if(!('BarcodeDetector' in window)){
    alert("Camera scanning not supported on this browser");
    return;
  }

  const video=document.getElementById("video");
  video.style.display="block";

  stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  video.srcObject=stream;
  await video.play();

  const detector=new BarcodeDetector({formats:["ean_13","ean_8","upc_a","upc_e"]});

  const scanLoop=async()=>{
    const codes=await detector.detect(video);
    if(codes.length){
      document.getElementById("barcode").value=codes[0].rawValue;
      stopScan();
    }else{
      requestAnimationFrame(scanLoop);
    }
  };
  scanLoop();
}

function stopScan(){
  const video=document.getElementById("video");
  video.style.display="none";
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream=null;
  }
}

async function checkFood(){
  stopScan();
  const code=document.getElementById("barcode").value.trim();
  const out=document.getElementById("output");
  out.innerHTML="";

  if(!code){
    alert("Enter barcode");
    return;
  }

  const res=await fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`);
  const data=await res.json();
  if(!data.product){
    out.innerHTML="<p>‚ùå Product not found in database.</p>";
    return;
  }

  const p=data.product;
  const name=p.product_name||"Food Item";
  const ing=p.ingredients_text||"Not available";
  const n=p.nutriments||{};
  const sugar=n.sugars_100g ?? null;
  const fat=n.saturated_fat_100g ?? null;
  const fiber=n.fiber_100g ?? null;

  let score=100,reasons=[],suggestions=[],warning="";

  if(sugar!==null && sugar>10){score-=40;reasons.push("High sugar")}
  if(fat!==null && fat>5){score-=25;reasons.push("High saturated fat")}
  if(fiber!==null && fiber<2){score-=15;reasons.push("Low fiber")}

  const softDrink=ing.toLowerCase().includes("carbonated") && ing.toLowerCase().includes("sugar");
  if(softDrink){
    score=Math.min(score,30);
    reasons.push("Sugary beverage");
    suggestions.push("Avoid sugary drinks");
  }

  if(sugar===null || fat===null){
    warning="‚ö†Ô∏è Result based on limited nutrition data";
  }

  let cls="healthy",label="Healthy choice";
  if(score<40){cls="unhealthy";label="Unhealthy"}
  else if(score<70){cls="moderate";label="Moderate"}

  if(suggestions.length===0){
    suggestions.push("Consume in moderation");
  }

  out.innerHTML=`
    <div class="score ${cls}">${score}</div>
    <h2 style="text-align:center">${name}</h2>
    <p style="text-align:center">${label}</p>

    <b>Why?</b>
    <ul>${reasons.map(r=>`<li>${r}</li>`).join("")}</ul>

    <b>Suggestions</b>
    <ul>${suggestions.map(s=>`<li>${s}</li>`).join("")}</ul>

    <b>Ingredients</b>
    <div class="ingredients">${ing}</div>

    ${warning?`<div class="warning">${warning}</div>`:""}
  `;
}
</script>
</body>
</html>