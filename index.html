<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nutri - Smart Food Scanner</title>
<style>
:root{
  --bg:#0b0b0b;
  --card:#141414;
  --green:#4caf50;
  --text:#ffffff;
  --muted:#9e9e9e;
  --red:#ef5350;
  --yellow:#ffb74d;
  --premium-glow: rgba(76, 175, 80, 0.15);
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  background:var(--bg);
  color:var(--text);
  line-height: 1.5;
}

.container{ max-width:460px; margin:auto; padding:16px; }
h1{color:var(--green);margin:4px 0; font-size: 28px; letter-spacing: -1px;}
.tagline{color:var(--muted);font-size:14px;margin-bottom:12px}

.card{
  background:var(--card);
  border-radius:22px;
  padding:20px;
  margin-bottom:14px;
  border: 1px solid #222;
}

/* Premium Scoring UI */
.score-container {
    position: relative;
    width: 120px;
    height: 120px;
    margin: 20px auto;
}

.score{
  width: 100%; height: 100%; border-radius:50%;
  display:flex; flex-direction: column; align-items:center; justify-content:center;
  font-size:36px; font-weight: 800;
  box-shadow: 0 0 30px var(--premium-glow);
  transition: 0.5s ease;
}

.score span { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; margin-top: -4px; }

/* Alert Boxes */
.alert-box {
    background: rgba(255, 255, 255, 0.03);
    border-radius: 14px;
    padding: 16px;
    margin-top: 15px;
}

.alert-item {
    display: flex;
    gap: 12px;
    margin-bottom: 12px;
    border-left: 3px solid var(--red);
    padding-left: 12px;
}

.alert-item b { display: block; font-size: 13px; color: var(--red); text-transform: uppercase; }
.alert-item p { margin: 2px 0 0 0; font-size: 13px; color: #bbb; }

/* Visual Elements */
#videoContainer {
  position: relative; width: 100%; border-radius: 18px; overflow: hidden; display: none; margin-bottom: 12px;
}
.scan-region {
  position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
  width: 70%; height: 50%; border: 2px solid var(--green); border-radius: 12px;
  box-shadow: 0 0 0 9999px rgba(0,0,0,0.7); pointer-events: none;
}

input{
  width:100%; padding:14px; font-size:16px; border-radius:12px;
  border:1px solid #333; background:#000; color:#fff; margin-bottom:12px;
}

button{ width:100%; padding:14px; border:none; border-radius:12px; font-weight:bold; cursor:pointer; }
.scanBtn{background:#222; color:#fff; margin-bottom:8px}
.checkBtn{background:var(--green); color:#000}

.tabs{ display:flex; gap:8px; margin-bottom:16px; }
.tab{
  flex:1; text-align:center; padding:12px 4px; border-radius:12px;
  background:#1a1a1a; color:#666; cursor:pointer; font-size: 11px; font-weight: bold; text-transform: uppercase;
}
.tab.active{ background:var(--green); color:#000; }

.nutri-table { width: 100%; border-collapse: collapse; }
.nutri-table td { padding: 12px 0; border-bottom: 1px solid #222; font-size: 14px; }
.val-bad { color: var(--red); font-weight: bold; }
.val-good { color: var(--green); font-weight: bold; }

.hidden{display:none}
</style>

<script>
let stream = null;

function openTab(id, el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.screen').forEach(d=>d.classList.add('hidden'));
  el.classList.add('active');
  document.getElementById(id).classList.remove('hidden');
}

/* CHEMICAL & PACKAGING ANALYSIS */
function getChemicalAlerts(p) {
  const alerts = [];
  const ingredients = (p.ingredients_text || "").toLowerCase();
  const packaging = (p.packaging || "").toLowerCase();
  
  // 1. "Forever Chemicals" (PFAS) Logic
  // Focuses on grease-proof packaging common in certain food categories
  const pfasPackaging = ["wrapper", "bag", "paper", "cardboard"];
  const pfasFoods = ["popcorn", "burger", "wrap", "fast food", "bakery"];
  
  if (pfasPackaging.some(t => packaging.includes(t)) || pfasFoods.some(f => p.categories?.toLowerCase().includes(f))) {
    alerts.push({
      label: "PFAS Risk",
      msg: "Packaging type often utilizes PFAS (Forever Chemicals) for grease resistance.",
      color: "var(--yellow)"
    });
  }

  // 2. Controversial Chemical Additives
  const chemicals = {
    "titanium dioxide": "E171 - Potential DNA damage risk (Banned in EU).",
    "aspartame": "Artificial sweetener linked to metabolic disruption.",
    "potassium bromate": "Banned carcinogen in many regions; used in flours.",
    "sodium nitrite": "Preservative linked to higher colon cancer risk.",
    "bha": "Endocrine disruptor used to prevent oils from spoiling.",
    "red 40": "Petroleum-derived dye linked to hyperactivity."
  };

  for (const [key, val] of Object.entries(chemicals)) {
    if (ingredients.includes(key)) {
      alerts.push({ label: "Chemical Alert", msg: val, color: "var(--red)" });
    }
  }

  // 3. Processing level (NOVA)
  if (p.nova_group === 4) {
    alerts.push({
      label: "Ultra-Processed",
      msg: "NOVA Group 4: Industrial formulation with high chemical load.",
      color: "#ffb74d"
    });
  }

  return alerts;
}

async function checkFood() {
  const code = document.getElementById("barcode").value.trim();
  if(!code) return;
  
  const btn = document.getElementById("checkBtn");
  btn.innerText = "Analyzing Micro-data...";
  btn.disabled = true;

  try {
    const res = await fetch(`https://world.openfoodfacts.org/api/v2/product/${code}.json`);
    const data = await res.json();
    if(!data.product) { alert("Unknown Barcode"); return; }
    renderProduct(data.product);
  } catch (e) {
    alert("API Connection Error");
  } finally {
    btn.innerText = "Check Food";
    btn.disabled = false;
  }
}

function renderProduct(p) {
  const alerts = getChemicalAlerts(p);
  const n = p.nutriments || {};
  
  // Scoring
  let score = 100;
  if(n.sugars_100g > 10) score -= 30;
  if(p.nova_group === 4) score -= 25;
  score -= (alerts.length * 10);
  score = Math.max(0, score);

  const status = score > 70 ? "healthy" : (score > 40 ? "moderate" : "unhealthy");

  // Overview Tab
  document.getElementById('overview').innerHTML = `
    <div class="score-container">
        <div class="score ${status}">${score}<span>Score</span></div>
    </div>
    
    <div style="text-align:center; margin-bottom:20px">
      <h2 style="margin:0">${p.product_name || 'Premium Item'}</h2>
      <div style="font-size:12px; color:var(--green); margin-top:4px; letter-spacing:1px">
        ${p.brands ? p.brands.toUpperCase() : 'PURE GRADE'}
      </div>
    </div>

    <div class="alert-box">
      <h4 style="margin:0 0 15px 0; font-size:12px; color:var(--muted); letter-spacing:1px">CHEMICAL & PACKAGING ANALYSIS</h4>
      ${alerts.length > 0 ? alerts.map(a => `
        <div class="alert-item" style="border-color:${a.color}">
          <b style="color:${a.color}">${a.label}</b>
          <p>${a.msg}</p>
        </div>
      `).join('') : '<p style="color:var(--green); font-size:13px">âœ“ No high-risk chemicals or PFAS packaging detected.</p>'}
    </div>
  `;

  // Nutrition Tab (Condensed)
  document.getElementById('nutrition').innerHTML = `
    <h3>Biometric Data (100g)</h3>
    <table class="nutri-table">
      <tr><td>Energy</td><td align="right">${n.energy_kcal_100g || 0} kcal</td></tr>
      <tr><td>Added Sugars</td><td align="right" class="${n.sugars_100g > 15 ? 'val-bad' : ''}">${n.sugars_100g || 0}g</td></tr>
      <tr><td>Processing Level</td><td align="right">NOVA Group ${p.nova_group || 'N/A'}</td></tr>
    </table>
  `;

  // Ingredients Tab
  document.getElementById('ingredients').innerHTML = `
    <h4 style="color:var(--muted)">Full Ingredient Ledger</h4>
    <p style="font-size:13px; color:#eee; line-height:1.6">${p.ingredients_text || "Analysis unavailable"}</p>
  `;
  
  openTab('overview', document.querySelector('.tab'));
}

// Camera Toggle Logic
async function toggleScan() {
  const container = document.getElementById("videoContainer");
  if (stream) {
    container.style.display = "none";
    stream.getTracks().forEach(t=>t.stop());
    stream = null;
  } else {
    container.style.display = "block";
    stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
    video.srcObject = stream;
    video.play();
  }
}
</script>
</body>
</html>
