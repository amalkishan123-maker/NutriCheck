<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nutri</title>

<link rel="manifest" href="manifest.json">

<style>
:root{
  --bg:#0b0b0b;
  --card:#141414;
  --green:#4caf50;
  --text:#ffffff;
  --muted:#9e9e9e;
  --red:#ef5350;
  --yellow:#ffb74d;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:Arial,Helvetica,sans-serif;
  background:var(--bg);
  color:var(--text);
}

.container{
  max-width:460px;
  margin:auto;
  padding:16px;
}

h1{color:var(--green);margin:4px 0}
.tagline{color:var(--muted);font-size:14px;margin-bottom:12px}

.card{
  background:var(--card);
  border-radius:14px;
  padding:14px;
  margin-bottom:14px;
}

.screen{
  animation:slideFade .35s ease;
}

@keyframes slideFade{
  from{opacity:0;transform:translateX(12px)}
  to{opacity:1;transform:translateX(0)}
}

input{
  width:100%;
  padding:12px;
  font-size:16px;
  border-radius:10px;
  border:none;
  background:#1f1f1f;
  color:#fff;
  margin-bottom:10px;
}

button{
  width:100%;
  padding:13px;
  border:none;
  border-radius:10px;
  font-weight:bold;
  cursor:pointer;
}

.scanBtn{background:#222;color:#fff;margin-bottom:8px}
.checkBtn{background:var(--green);color:#000}

.tabs{
  display:flex;
  gap:6px;
  margin-bottom:12px;
}
.tab{
  flex:1;
  text-align:center;
  padding:10px;
  border-radius:10px;
  background:#1f1f1f;
  color:#bbb;
  cursor:pointer;
}
.tab.active{
  background:var(--green);
  color:#000;
  font-weight:bold;
}

.score{
  width:120px;
  height:120px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:34px;
  margin:12px auto;
}
.healthy{background:#1b5e20}
.moderate{background:#f9a825;color:#000}
.unhealthy{background:#8e0000}

.good{color:#66bb6a}
.bad{color:#ef5350}

details{
  background:#111;
  border-radius:10px;
  padding:10px;
  margin-bottom:8px;
}
details summary{cursor:pointer;font-weight:bold}

.row{
  display:flex;
  justify-content:space-between;
  padding:8px 0;
}

.value.good{color:#66bb6a}
.value.mid{color:#ffb74d}
.value.bad{color:#ef5350}

.hidden{display:none}

footer{
  text-align:center;
  font-size:12px;
  color:#888;
  margin-top:12px;
}
</style>
</head>

<body>
<div class="container">

<h1>Nutri</h1>
<div class="tagline">Scan Â· Understand Â· Decide</div>

<div class="card">
  <input id="barcode" placeholder="Enter barcode number">
  <button class="scanBtn" onclick="startScan()">ğŸ“· Scan Barcode</button>
  <button class="checkBtn" onclick="checkFood()">Check Food</button>
  <video id="video" style="width:100%;border-radius:10px;display:none"></video>
</div>

<div class="tabs">
  <div class="tab active" onclick="openTab('home')">Home</div>
  <div class="tab" onclick="openTab('overview')">Overview</div>
  <div class="tab" onclick="openTab('nutrition')">Nutrition</div>
  <div class="tab" onclick="openTab('ingredients')">Ingredients</div>
</div>

<div id="home" class="card screen">
  <h3>What is Nutri Score?</h3>
  <p>
    Nutri Score represents the overall nutritional quality of a food product
    based on nutrition and ingredient data.
  </p>
  <ul>
    <li>ğŸŸ¢ <b>70â€“100</b> â†’ Healthy</li>
    <li>ğŸŸ¡ <b>40â€“69</b> â†’ Moderate</li>
    <li>ğŸ”´ <b>0â€“39</b> â†’ Unhealthy</li>
  </ul>
</div>

<div id="overview" class="card hidden screen"></div>
<div id="nutrition" class="card hidden screen"></div>
<div id="ingredients" class="card hidden screen"></div>

<footer>
  Data source: Open Food Facts<br>
  Results are indicative, not medical advice
</footer>

</div>

<script>
function openTab(id){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('#home,#overview,#nutrition,#ingredients')
    .forEach(d=>d.classList.add('hidden'));

  document.getElementById(id).classList.remove('hidden');
  [...document.querySelectorAll('.tab')]
    .find(t=>t.textContent.toLowerCase().includes(id))
    .classList.add('active');

  window.scrollTo({top:0,behavior:"smooth"});
}

/* CAMERA SCAN */
let stream=null;
async function startScan(){
  if(!('BarcodeDetector'in window)){
    alert("Camera scan not supported");
    return;
  }
  const v=document.getElementById("video");
  v.style.display="block";
  stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  v.srcObject=stream;
  await v.play();
  const d=new BarcodeDetector({formats:["ean_13","ean_8","upc_a","upc_e"]});
  (async function scan(){
    const c=await d.detect(v);
    if(c.length){
      barcode.value=c[0].rawValue;
      stopScan();
    }else requestAnimationFrame(scan);
  })();
}
function stopScan(){
  const v=document.getElementById("video");
  v.style.display="none";
  if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;}
}

/* ğŸ” FIND BETTER BRAND (DYNAMIC) */
async function findBetterBrand(category, currentSugar, currentFiber){
  if(!category) return null;

  const url = `https://world.openfoodfacts.org/cgi/search.pl?search_terms=&search_simple=1&action=process&page_size=15&json=1&tagtype_0=categories&tag_contains_0=contains&tag_0=${encodeURIComponent(category)}`;
  const res = await fetch(url);
  const data = await res.json();
  if(!data.products) return null;

  for(const prod of data.products){
    const n = prod.nutriments || {};
    const sugar = n.sugars_100g ?? 999;
    const fiber = n.fiber_100g ?? 0;

    if(sugar < currentSugar || fiber > currentFiber){
      return prod.product_name || null;
    }
  }
  return null;
}

/* FOOD CHECK */
async function checkFood(){
  const code=barcode.value.trim();
  if(!code){alert("Enter barcode");return;}

  openTab('overview');

  const r=await fetch(`https://world.openfoodfacts.org/api/v0/product/${code}.json`);
  const d=await r.json();
  if(!d.product){
    overview.innerHTML="âŒ Product not found";
    return;
  }

  const p=d.product;
  const n=p.nutriments||{};
  const ing=p.ingredients_text||"Ingredients not available";
  const category = p.categories?.split(",")[0] || "";

  const sugar=n.sugars_100g ?? null;
  const fat=n.saturated_fat_100g ?? null;
  const fiber=n.fiber_100g ?? null;
  const energy=n.energy_kcal_100g ?? null;

  let score=100;
  let good=[],bad=[],suggestions=[];

  if(sugar!==null && sugar>8){
    score-=60;
    bad.push("High sugar");
    suggestions.push("Limit sugary foods and drinks");
  }
  if(fat!==null && fat>5){
    score-=25;
    bad.push("High saturated fat");
    suggestions.push("Prefer low-fat options");
  }
  if(fiber!==null && fiber<2){
    score-=15;
    bad.push("Low fiber");
    suggestions.push("Choose fiber-rich foods");
  }
  if(p.categories && p.categories.toLowerCase().includes("beverages")){
    score-=20;
    bad.push("Sugary beverage");
    suggestions.push("Avoid frequent consumption");
  }

  if(fiber!==null && fiber>=3) good.push("Good fiber content");
  if(sugar!==null && sugar<=5) good.push("Low sugar");

  score=Math.max(0,Math.min(100,score));

  let cls="healthy",label="Healthy choice";
  if(score<40){cls="unhealthy";label="Unhealthy choice"}
  else if(score<70){cls="moderate";label="Consume in moderation"}

  overview.innerHTML=`
    <div class="score ${cls}">${score}</div>
    <div style="text-align:center"><b>${p.product_name||"Food Item"}</b><br>${label}</div>

    <h4 class="good">ğŸ™‚ What We Like</h4>
    <ul>${good.length?good.map(x=>`<li>${x}</li>`).join(""):"<li>No significant nutritional benefits</li>"}</ul>

    <h4 class="bad">ğŸ˜Ÿ What Concerns Us</h4>
    <ul>${bad.length?bad.map(x=>`<li>${x}</li>`).join(""):"<li>No major nutritional concerns</li>"}</ul>

    <h4>ğŸ’¡ Suggestions</h4>
    <ul>${suggestions.length?suggestions.map(s=>`<li>${s}</li>`).join(""):"<li>Consume in moderation</li>"}</ul>
  `;

  if(score < 70){
    const better = await findBetterBrand(category, sugar ?? 999, fiber ?? 0);
    overview.innerHTML += better
      ? `<h4>ğŸ” Better Brand Suggestion</h4><p><b>${better}</b></p>`
      : `<h4>ğŸ” Better Brand Suggestion</h4><p style="color:var(--muted)">No healthier alternative found.</p>`;
  }

  nutrition.innerHTML=`
    <details open><summary>Energy</summary>
      <div class="row"><span>Energy</span><span class="value mid">${energy??"N/A"} kcal</span></div>
    </details>
    <details><summary>Total Sugars</summary>
      <div class="row"><span>Sugars</span><span class="value bad">${sugar??"N/A"} g</span></div>
    </details>
    <details><summary>Saturated Fat</summary>
      <div class="row"><span>Fat</span><span class="value bad">${fat??"N/A"} g</span></div>
    </details>
    <details><summary>Dietary Fiber</summary>
      <div class="row"><span>Fiber</span><span class="value good">${fiber??"N/A"} g</span></div>
    </details>
  `;

  ingredients.innerHTML=`
    <p>${ing}</p>
    <p style="color:var(--muted);font-size:12px">
      Ingredients may appear in the productâ€™s country language.
    </p>
  `;
}

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js');
}
</script>

</body>
</html>