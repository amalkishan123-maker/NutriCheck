<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nutri</title>

<link rel="manifest" href="manifest.json">
<script src="https://unpkg.com/@zxing/library@latest"></script>

<style>
:root{
  --bg:#0b0b0b;
  --card:#141414;
  --green:#4caf50;
  --red:#ef5350;
  --orange:#ffb74d;
  --text:#ffffff;
  --muted:#9e9e9e;
}

body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui,Arial;
}

.container{
  max-width:430px;
  margin:auto;
  padding:16px;
}

.card{
  background:var(--card);
  border-radius:18px;
  padding:16px;
  margin-bottom:16px;
  box-shadow:0 10px 40px rgba(0,0,0,.6);
}

input{
  width:100%;
  padding:12px;
  border-radius:12px;
  border:none;
  background:#1f1f1f;
  color:#fff;
  font-size:16px;
  margin-bottom:10px;
}

button{
  width:100%;
  padding:13px;
  border:none;
  border-radius:12px;
  font-weight:bold;
  cursor:pointer;
}

.scanBtn{background:#222;color:white;margin-bottom:8px}
.checkBtn{background:var(--green);color:black}

video{
  width:100%;
  border-radius:12px;
  display:none;
  margin-top:10px;
}

/* SCORE CIRCLE */
.scoreWrap{
  display:flex;
  justify-content:center;
  margin-top:20px;
}
.scoreCircle{
  width:160px;
  height:160px;
  border-radius:50%;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  font-size:48px;
  font-weight:bold;
  color:var(--green);
  box-shadow:0 0 40px rgba(76,175,80,.6);
}
.scoreCircle span{
  font-size:14px;
  color:var(--muted);
  letter-spacing:2px;
}

/* BARS */
.barRow{margin:14px 0}
.barLabel{
  display:flex;
  justify-content:space-between;
  margin-bottom:6px;
}
.bar{
  width:100%;
  height:14px;
  background:#222;
  border-radius:20px;
  overflow:hidden;
}
.barFill{
  height:100%;
  background:var(--red);
  width:0%;
  border-radius:20px;
}

.processCard{
  text-align:center;
  padding:18px;
  background:black;
  border-radius:16px;
  font-size:22px;
  font-weight:bold;
  color:var(--orange);
}

.hidden{display:none}
.center{text-align:center}
.small{font-size:13px;color:var(--muted)}
</style>
</head>

<body>
<div class="container">

<div class="card">
  <input id="barcode" placeholder="Enter barcode">
  <button class="scanBtn" onclick="toggleCamera()">ðŸ“· Scan</button>
  <button class="checkBtn" onclick="analyze()">Analyze</button>
  <video id="video"></video>
</div>

<div id="result" class="hidden">

<div class="card center">
  <div class="scoreWrap">
    <div id="scoreCircle" class="scoreCircle">
      0
      <span>SCORE</span>
    </div>
  </div>
  <h2 id="pname">Product</h2>
  <div id="brand" class="small"></div>
</div>

<div class="card">
  <h3>Nutritional Profile (100g)</h3>

  <div class="barRow">
    <div class="barLabel"><span>Sugar</span><span id="sugarVal"></span></div>
    <div class="bar"><div id="sugarBar" class="barFill"></div></div>
  </div>

  <div class="barRow">
    <div class="barLabel"><span>Total Fat</span><span id="fatVal"></span></div>
    <div class="bar"><div id="fatBar" class="barFill"></div></div>
  </div>

  <div class="barRow">
    <div class="barLabel"><span>Energy</span><span id="energyVal"></span></div>
    <div class="bar"><div id="energyBar" class="barFill"></div></div>
  </div>
</div>

<div class="card">
  <div class="processCard">
    PROCESSING LEVEL<br>
    <span id="nova">NOVA Group 4</span>
  </div>
</div>

<div class="card">
  <h3>Ingredients</h3>
  <p id="ingredients" class="small"></p>
</div>

</div>
</div>

<script>
const codeReader = new ZXing.BrowserMultiFormatReader();
let cameraOn=false;

function toggleCamera(){
  const video=document.getElementById("video");
  if(!cameraOn){
    cameraOn=true;
    video.style.display="block";
    codeReader.decodeFromVideoDevice(null,"video",(res,err)=>{
      if(res){
        barcode.value=res.text;
        toggleCamera();
        analyze();
      }
    });
  }else{
    cameraOn=false;
    codeReader.reset();
    video.style.display="none";
  }
}

async function analyze(){
  const code=barcode.value.trim();
  if(!code) return alert("Enter barcode");

  const res=await fetch(`/api/check/${code}`);
  const data=await res.json();
  if(data.error) return alert("Not found");

  result.classList.remove("hidden");

  const sugar=parseFloat(data.sugar)||0;
  const fat=parseFloat(data.fat)||0;
  const energy=parseFloat(data.energy)||0;

  let score=100 - (sugar*4) - (fat*3);
  score=Math.max(0,Math.min(100,Math.round(score)));

  pname.innerText=data.productName;
  brand.innerText=data.brand || "";
  scoreCircle.innerHTML=score+"<span>SCORE</span>";

  if(score<40) scoreCircle.style.color="#ef5350";
  else if(score<70) scoreCircle.style.color="#ffb74d";
  else scoreCircle.style.color="#4caf50";

  sugarVal.innerText=sugar+"g";
  fatVal.innerText=fat+"g";
  energyVal.innerText=energy+" kcal";

  sugarBar.style.width=Math.min(sugar,60)/60*100+"%";
  fatBar.style.width=Math.min(fat,40)/40*100+"%";
  energyBar.style.width=Math.min(energy,400)/400*100+"%";

  ingredients.innerText=data.ingredients || "Not available";
}

if("serviceWorker"in navigator){
  navigator.serviceWorker.register("service-worker.js");
}
</script>
</body>
</html>