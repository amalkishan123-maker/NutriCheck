<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nutri</title>

<link rel="manifest" href="manifest.json">
<script src="https://unpkg.com/@zxing/library@latest"></script>

<style>
:root{
  --bg:#0b0b0b;
  --card:#141414;
  --green:#4caf50;
  --text:#ffffff;
  --muted:#9e9e9e;
  --red:#ef5350;
  --yellow:#ffb74d;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:Arial,Helvetica,sans-serif;
  background:var(--bg);
  color:var(--text);
}

.container{
  max-width:460px;
  margin:auto;
  padding:16px;
}

h1{color:var(--green);margin:4px 0}
.tagline{color:var(--muted);font-size:14px;margin-bottom:12px}

.card{
  background:var(--card);
  border-radius:14px;
  padding:14px;
  margin-bottom:14px;
}

input, button{
  width:100%;
  padding:12px;
  border-radius:10px;
  border:none;
  margin-bottom:10px;
  font-size:16px;
}

input{background:#1f1f1f;color:#fff}
button{font-weight:bold;cursor:pointer}
.checkBtn{background:var(--green);color:#000}

.tabs{
  display:flex;
  gap:6px;
  margin-bottom:12px;
}
.tab{
  flex:1;
  text-align:center;
  padding:10px;
  border-radius:10px;
  background:#1f1f1f;
  color:#bbb;
  cursor:pointer;
}
.tab.active{
  background:var(--green);
  color:#000;
}

.score{
  width:120px;height:120px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:34px;
  margin:12px auto;
}
.healthy{background:#1b5e20}
.moderate{background:#f9a825;color:#000}
.unhealthy{background:#8e0000}

.hidden{display:none}
.good{color:#66bb6a}
.bad{color:#ef5350}

footer{text-align:center;font-size:12px;color:#888;margin-top:12px}

/* NUTRITION BARS */
.barRow{margin-bottom:12px}
.barLabel{display:flex;justify-content:space-between;font-size:14px}
.bar{background:#222;border-radius:8px;height:10px;overflow:hidden}
.barFill{background:#4caf50;height:100%}

/* PROCESSING BARS */
.progress{
  background:#222;
  border-radius:8px;
  height:10px;
  overflow:hidden;
  margin-bottom:10px;
}
.progressFill{height:100%}
.progressFill.green{background:#4caf50}
.progressFill.red{background:#ef5350}
</style>
</head>

<body>
<div class="container">

<h1>Nutri</h1>
<div class="tagline">Scan ¬∑ Understand ¬∑ Decide</div>

<div class="card">
  <input id="barcode" placeholder="Enter barcode">
  <button onclick="toggleCamera()">üì∑ Scan Barcode</button>
  <video id="video" style="width:100%;border-radius:10px;display:none"></video>
  <button class="checkBtn" onclick="checkFood()">Check Food</button>
</div>

<div class="tabs">
  <div class="tab active" onclick="openTab('home',this)">Home</div>
  <div class="tab" onclick="openTab('overview',this)">Overview</div>
  <div class="tab" onclick="openTab('nutrition',this)">Nutrition</div>
  <div class="tab" onclick="openTab('ingredients',this)">Ingredients</div>
</div>

<div id="home" class="card">
  <h3>Nutri Score</h3>
  <ul>
    <li>üü¢ 70‚Äì100 ‚Üí Healthy</li>
    <li>üü° 40‚Äì69 ‚Üí Moderate</li>
    <li>üî¥ 0‚Äì39 ‚Üí Unhealthy</li>
  </ul>
</div>

<div id="overview" class="card hidden"></div>
<div id="nutrition" class="card hidden"></div>
<div id="ingredients" class="card hidden"></div>

<footer>
Data source: Open Food Facts<br>
Results are indicative, not medical advice
</footer>

</div>

<script>
const barcode = document.getElementById("barcode");
const overview = document.getElementById("overview");
const nutrition = document.getElementById("nutrition");
const ingredients = document.getElementById("ingredients");
const video = document.getElementById("video");

let cameraOn = false;
const codeReader = new ZXing.BrowserMultiFormatReader();

function openTab(id,el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('#home,#overview,#nutrition,#ingredients')
    .forEach(d=>d.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  el.classList.add('active');
}

function toggleCamera(){
  if(!cameraOn){
    cameraOn = true;
    video.style.display = "block";
    codeReader.decodeFromVideoDevice(null, "video", (res) => {
      if(res){
        barcode.value = res.text;
        toggleCamera();
        checkFood();
      }
    });
  } else {
    cameraOn = false;
    codeReader.reset();
    video.style.display = "none";
  }
}

async function checkFood(){
  const code = barcode.value.trim();
  if(!code){ alert("Enter barcode"); return; }

  openTab('overview',document.querySelectorAll('.tab')[1]);

  const res = await fetch(`/api/check/${code}`);
  const data = await res.json();

  if(data.error){
    overview.innerHTML = "‚ùå Product not found";
    return;
  }

  const sugar = data.sugar || 0;
  const fat = data.fat || 0;
  const fiber = data.fiber || 0;
  const energy = data.energy || 0;

  let score = data.score || 50;

  let cls="healthy", label="Healthy";
  if(score<40){cls="unhealthy";label="Unhealthy";}
  else if(score<70){cls="moderate";label="Moderate";}

  overview.innerHTML = `
    <div class="score ${cls}">${score}</div>
    <div style="text-align:center">
      <b>${data.productName}</b><br>${label}
    </div>
    <h4>üîÅ Better Brand</h4>
    <p>${data.alternativeBrand || "No better brand found"}</p>
  `;

  nutrition.innerHTML = `
  <h2>Nutritional Profile (100g)</h2>

  <div class="barRow">
    <div class="barLabel"><span>Sugar</span><span>${sugar}g</span></div>
    <div class="bar"><div class="barFill" style="width:${Math.min(sugar,60)/60*100}%"></div></div>
  </div>

  <div class="barRow">
    <div class="barLabel"><span>Fat</span><span>${fat}g</span></div>
    <div class="bar"><div class="barFill" style="width:${Math.min(fat,40)/40*100}%"></div></div>
  </div>

  <div class="barRow">
    <div class="barLabel"><span>Energy</span><span>${energy} kcal</span></div>
    <div class="bar"><div class="barFill" style="width:${Math.min(energy,400)/400*100}%"></div></div>
  </div>
  `;

  ingredients.innerHTML = `
<h3>üß™ Chemical Analysis</h3>

<p class="bad"><b>Harmful</b></p>
<ul>
  ${
    data.ingredientAnalysis?.harmful?.length
      ? data.ingredientAnalysis.harmful.map(i=>`<li>${i}</li>`).join("")
      : "<li>None detected</li>"
  }
</ul>

<p><b>Use with caution</b></p>
<ul>
  ${
    data.ingredientAnalysis?.caution?.length
      ? data.ingredientAnalysis.caution.map(i=>`<li>${i}</li>`).join("")
      : "<li>None detected</li>"
  }
</ul>

<p class="good"><b>Safe</b></p>
<ul>
  ${
    data.ingredientAnalysis?.safe?.length
      ? data.ingredientAnalysis.safe.map(i=>`<li>${i}</li>`).join("")
      : "<li>Basic natural ingredients</li>"
  }
</ul>

<h3>üìã Full Ingredients</h3>
<p>${data.ingredients || "Ingredients not available"}</p>

<hr style="margin:16px 0;opacity:0.2">

<h3>‚ö†Ô∏è Processing Level</h3>
<h2 style="color:#ef5350">${data.novaGroup}</h2>

<p>Total Ingredients: 
<b>${data.ingredients ? data.ingredients.split(",").length : "Unknown"}</b></p>

<h3>Natural vs Artificial</h3>

<p class="good">Natural: ${data.naturalPercent}%</p>
<div class="progress">
  <div class="progressFill green" style="width:${data.naturalPercent}%"></div>
</div>

<p class="bad">Artificial: ${data.artificialPercent}%</p>
<div class="progress">
  <div class="progressFill red" style="width:${data.artificialPercent}%"></div>
</div>

<h3>üß† AI Health Risk Detection</h3>
<ul>
  ${
    data.healthRisks?.length
      ? data.healthRisks.map(r=>`<li>${r}</li>`).join("")
      : "<li>No major risks detected</li>"
  }
</ul>

<h3>Overall Health Score</h3>
<h2 style="color:#ffb74d">${score} / 100</h2>
`;
}

if("serviceWorker" in navigator){
navigator.serviceWorker.register("service-worker.js");
}
</script>
</body>
</html>
'''xx
